<html>
	<head>
		<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
		<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
		<style>
			.error {
				color: #d32f2f;
			}
			.success {
				color: #388e3c;
			}
		</style>

		<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
		<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
		<script type="text/javascript" src="../../js/translate.js"></script>
		<script type="text/javascript" src="../../lib/js/materialize.js"></script>
		<script type="text/javascript" src="../../js/adapter-settings.js"></script>
		<script type="text/javascript" src="words.js"></script>
		<script type="text/javascript">

			// enable/disable "getAutToken-Button"
			function setStates() {
				if ($("#gatewayIP").val() &&	// gatewayIP must be entered
					$("#username").val())		// username must be entered
				{
					$("#getAuthToken").attr("disabled", false);
					$("#getAuthTokenHint").removeClass().text("");
				} else {
					$("#getAuthToken").attr("disabled", true);
				}
			}

			function load(settings, onChange) {
				if (!settings) return;

				// handle value changes
				$(".value").on("input change", function() {
					setStates();

					// if something changed, enable save buttons when all fields are filled
					if ($("#gatewayIP").val() &&	// gatewayIP must be set
						$("#username").val() &&		// username must be set
						$("#authToken").val() &&	// authToken must be set
						$("#intervalTime").val())	// intervalTime must be set
					{
						onChange(true);
					} else {
						onChange(false);
					};

					M.updateTextFields();
				});

				$("#gatewayIP").val(settings["gatewayIP"]);
				$("#username").val(settings["username"]);
				$("#authToken").val(settings["authToken"]);
				$("#intervalTime").val(settings["intervalTime"]);

				$("#getAuthToken").click(function() {
					// Check if adapter is running
					getIsAdapterAlive("wiserbyfeller", function(alive) {
						// adapter must be running
						if (alive) {
							$("#getAuthToken").attr("disabled", true);	// disable "getAutToken-Button" after click

							var hostConfig = new Object();
							hostConfig.gatewayIP = $("#gatewayIP").val();
							hostConfig.username = $("#username").val();

							sendTo("wiserbyfeller." + instance, "getAuthToken", hostConfig, function (response) {
								if (response.message == "SuccessGetAuthToken") {
									$("#authToken").val(response.authToken).trigger("focus");
									$("#getAuthToken").attr("disabled", true);
									$("#getAuthTokenHint").removeClass().addClass("success").text(translateWord("SuccessGetAuthToken"));
									onChange(true);
								}
								else {
									showMessage("<p>" + translateWord("error") + ': ' + response.message.message + "</p>", translateWord("ErrorGetAuthTokenTitle"), "info");
									$("#getAuthToken").attr("disabled", false);	// enable on error
									$("#getAuthTokenHint").removeClass().text("");
								}
							});

							$("#getAuthTokenHint").removeClass().text(translateWord("ObtainAuthTokenWait"));
						} else {
							showMessage("<p>" + translateWord("AdapterNotAlive") + "</p>", translateWord("AdapterStateTitle"), "info");
						}
					});
				});

				setStates();
				onChange(false);
				M.updateTextFields();
			}

			function save(callback) {
				var obj = {};
				obj["gatewayIP"] = $("#gatewayIP").val();
				obj["username"] = $("#username").val();
				obj["authToken"] = $("#authToken").val();
				obj["intervalTime"] = $("#intervalTime").val();
				callback(obj);
			}

		</script>

	</head>
	<body>

	<!-- Learn more http://materializecss.com -->

		<div class="m adapter-container">

			<div class="row">
				<div class="col s12 m4 l2">
					<img src="wiserbyfeller.png" class="logo">
				</div>
			</div>

			<!-- Put your content here -->

			<div class="row">
				<div class="col s12">
					<h6 class="translate">APIConnectionSettings</h6>
				</div>
			</div>
			<div class="row">
				<div class="input-field col s4 l4">
					<input
						id="gatewayIP"
						type="text"
						pattern="^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
						class="value validate"
						required
					>
					<label for="gatewayIP" class="translate">gatewayIP</label>
					<span class="translate">gatewayIPHint</span>
				</div>

				<div class="input-field col s4 l4">
					<input
						id="username"
						type="text"
						pattern="/[a-zA-Z0-9]{4,}$"
						class="value"
						required
					>
					<label for="username" class="translate">username</label>
					<span class="translate">usernameHint</span>
				</div>

				<div class="input-field col s4 l4">
					<input
						id="authToken"
						type="text"
						class="value"
						disabled
					>
					<label for="AuthToken" class="translate">AuthToken</label>
					<span class="translate">AuthTokenHint</span>
					<p><a class="waves-effect waves-light btn" id="getAuthToken" disabled><span class="translate">ButtonGetAuthToken</span></a></p>
					<span id="getAuthTokenHint"></span>
				</div>
			</div>

			<div class="row">
				<div class="input-field col s4 l4">
					<input
						id="intervalTime"
						type="number"
						min="5"
						max="300"
						class="value validate"
						required
					>
					<label for="intervalTime" class="translate">intervalTime</label>
					<span class="translate">intervallTimeHint</span>
				</div>
			</div>

			<div class="row">
				<div class="col s12">
					<p class="translate">on save adapter restarts with new config immediately</p>
				</div>
			</div>
		</div>

	</body>
</html>